# ==========================================================
#   Makefile for building dqr.dll (MSYS2 + PowerShell)
#   Deterministic build enabled
# ==========================================================

OUT_DIR     := Release
SRC_DIR     := src
INC_DIR     := include
CXX         := g++
SWIG        := swig
DECODER_VER := 0.17.0

# ==========================================================
#   Environment / Paths
# ==========================================================
ifeq ($(JNIINCLUDE),)
    $(error ❌ JNIINCLUDE environment variable is not set!)
endif

JNIINCLUDE_MSYS := $(shell cygpath -u "$(JNIINCLUDE)")

# ==========================================================
#   Deterministic Flags
# ==========================================================
# GNU determinism: remove build_id, timestamps, paths, metadata
CXXFLAGS  := -I"$(INC_DIR)" -D WINDOWS -std=c++11 -DDLL_EXPORT \
             -DDECODER_VERSION=\"$(DECODER_VER)\" -Wall -Wformat=0 \
             -fno-ident \
             -fdebug-prefix-map=$(PWD)=. \
             -fno-record-gcc-switches

LDFLAGS   := -shared -lws2_32 \
             -Wl,--build-id=none \
             -Wl,--no-insert-timestamp

SWIGFLAGS := -c++ -java -package com.sifive.trace -outdir com/sifive/trace \
             -I"$(INC_DIR)"

CPP_SRCS  := $(SRC_DIR)/dqr.cpp $(SRC_DIR)/trace.cpp \
             $(SRC_DIR)/vcd.cpp $(SRC_DIR)/dqr_interface.cpp

OBJS      := $(OUT_DIR)/dqr.o $(OUT_DIR)/trace.o \
             $(OUT_DIR)/vcd.o $(OUT_DIR)/dqr_interface.o

SWIG_CPP  := $(OUT_DIR)/dqr_wrap.cpp
SWIG_OBJ  := $(OUT_DIR)/dqr_wrap.o

TARGET    := $(OUT_DIR)/dqr.dll

# ==========================================================
#   Default target
# ==========================================================
all: $(TARGET)
	@echo "============================================="
	@echo "✅ Successfully built $(TARGET)"
	@echo "============================================="

# ==========================================================
#   Build steps
# ==========================================================
dirs:
	mkdir -p "$(OUT_DIR)"
	mkdir -p com/sifive/trace

$(OUT_DIR)/%.o: $(SRC_DIR)/%.cpp | dirs
	@echo "Compiling $<"
	$(CXX) $(CXXFLAGS) -c $< -o $@

$(SWIG_CPP): $(INC_DIR)/dqr.i | dirs
	@echo "Running SWIG to generate wrapper..."
	mkdir -p com/sifive/trace
	$(SWIG) $(SWIGFLAGS) -o "$(SWIG_CPP)" "$(INC_DIR)/dqr.i"

$(SWIG_OBJ): $(SWIG_CPP)
	@echo "Compiling SWIG wrapper using JNIINCLUDE=$(JNIINCLUDE)"
	$(CXX) $(CXXFLAGS) -c "$(SWIG_CPP)" -o "$(SWIG_OBJ)" \
		-I"$(JNIINCLUDE_MSYS)" \
		-I"$(JNIINCLUDE_MSYS)/win32"

$(TARGET): $(OBJS) $(SWIG_OBJ)
	@echo "Linking deterministic DLL..."
	$(CXX) $(OBJS) $(SWIG_OBJ) -o "$(TARGET)" $(LDFLAGS)

# ==========================================================
#   Clean — keep com/
# ==========================================================
clean:
	@echo "Cleaning compiled objects (keeping com/)..."
	rm -f $(OUT_DIR)/*.o $(OUT_DIR)/*.d $(OUT_DIR)/*.dll $(OUT_DIR)/*.exe $(OUT_DIR)/*.cpp

.PHONY: all clean dirs
