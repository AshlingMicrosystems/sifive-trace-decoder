name: Sifive Trace Decoder CI

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
  workflow_dispatch:    # üëà Allows manual/API triggers (e.g. from GitLab)

jobs:
  build-sifive-decoder:
    name: Build Sifive Trace Decoder
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install build dependencies
      run: sudo apt-get update && sudo apt-get install -y build-essential

    - name: Build Sifive Decoder
      run: |
        echo "üîπ Building Sifive Decoder"
        echo "Current directory: $(pwd)"
        echo "Directory contents:"
        ls -la
        echo "GITHUB_WORKSPACE: $GITHUB_WORKSPACE"

        # Build from repo root ‚Äî there is no project/linux/utility/trace folder
        cd "$GITHUB_WORKSPACE"

        # Clean and build all
        make CONFIG=Release clean
        make CONFIG=Release all

    - name: Prepare artifacts
      run: |
        echo "üîπ Preparing artifacts..."
        echo "Current directory: $(pwd)"
        echo "Checking Release folder:"
        ls -la "$GITHUB_WORKSPACE/Release" || true

        TRACE_LIB="$GITHUB_WORKSPACE/Release/libtrace.so"
        DECODER_LIB="$GITHUB_WORKSPACE/Release/libdqr.so"
        OBJDUMP_BIN="$GITHUB_WORKSPACE/bin/linux/objdump/riscv64-unknown-elf-objdump"

        # Validate outputs
        FOUND=0
        if [ -f "$TRACE_LIB" ]; then
          echo "‚úÖ Found libtrace.so"
          FOUND=1
        fi
        if [ -f "$DECODER_LIB" ]; then
          echo "‚úÖ Found libdqr.so"
          FOUND=1
        fi
         if [ -f "$OBJDUMP_BIN" ]; then
          echo "‚úÖ Found riscv64-unknown-elf-objdump"
          FOUND=1
        fi
        if [ $FOUND -eq 0 ]; then
          echo "‚ùå No .so files found in Release/"
          exit 1
        fi

        # Create artifacts directory
        mkdir -p "$GITHUB_WORKSPACE/artifacts/SifiveDecoder"

        # Copy whichever files exist
        [ -f "$TRACE_LIB" ] && cp "$TRACE_LIB" "$GITHUB_WORKSPACE/artifacts/SifiveDecoder/"
        [ -f "$DECODER_LIB" ] && cp "$DECODER_LIB" "$GITHUB_WORKSPACE/artifacts/SifiveDecoder/"
        [ -f "$OBJDUMP_BIN" ] && cp "$OBJDUMP_BIN" "$GITHUB_WORKSPACE/artifacts/SifiveDecoder/"

        echo "‚úÖ Artifacts prepared successfully:"
        ls -l "$GITHUB_WORKSPACE/artifacts/SifiveDecoder"

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: SifiveDecoder-libs       # üëà Artifact name for GitLab or downstream jobs
        path: ${{ github.workspace }}/artifacts/SifiveDecoder/
