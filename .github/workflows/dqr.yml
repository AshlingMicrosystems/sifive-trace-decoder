name: Sifive Trace Decoder CI

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
  workflow_dispatch:    # üëà Allows manual/API triggers (e.g. from GitLab)

jobs:
  build-sifive-decoder:
    name: Build Sifive Trace Decoder
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Build Sifive Decoder
      run: |
        echo "Building Sifive Decoder"
        echo "Current directory:"
        pwd
        echo "Directory contents:"
        ls -la
        echo "GITHUB_WORKSPACE: $GITHUB_WORKSPACE"

        # Navigate to decoder root directory
        cd "$GITHUB_WORKSPACE/project/linux/utility/trace"
        echo "Changed to trace utility directory:"
        pwd

        # Clean and build libtrace.so
        make CONFIG=Release clean
        make CONFIG=Release all

        # Now build the Sifive Trace Decoder core library
        cd "$GITHUB_WORKSPACE"
        echo "Building Sifive Trace Decoder core library..."
        make CONFIG=Release clean
        make CONFIG=Release all

    - name: Prepare artifacts
      run: |
        echo "Preparing Sifive Trace Decoder artifacts..."
        echo "Current directory:"
        pwd

        TRACE_LIB="$GITHUB_WORKSPACE/project/linux/utility/trace/Release/libtrace.so"
        DECODER_LIB="$GITHUB_WORKSPACE/Release/libdqr.so"

        # Validate build outputs
        if [ ! -f "$TRACE_LIB" ]; then
          echo "‚ùå libtrace.so not found!"
          exit 1
        fi
        if [ ! -f "$DECODER_LIB" ]; then
          echo "‚ùå libdqr.so not found!"
          exit 1
        fi

        # Create artifacts directory
        mkdir -p "$GITHUB_WORKSPACE/artifacts/SifiveDecoder"

        # Copy libraries
        cp "$TRACE_LIB" "$GITHUB_WORKSPACE/artifacts/SifiveDecoder/libtrace.so"
        cp "$DECODER_LIB" "$GITHUB_WORKSPACE/artifacts/SifiveDecoder/libdqr.so"

        echo "‚úÖ Artifacts prepared successfully:"
        ls -l "$GITHUB_WORKSPACE/artifacts/SifiveDecoder"

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: SifiveDecoder-libs       # üëà Artifact name for GitLab or downstream jobs
        path: ${{ github.workspace }}/artifacts/SifiveDecoder/
