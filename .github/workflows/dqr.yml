name: Sifive Trace Decoder CI

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-sifive-decoder:
    name: Build Sifive Trace Decoder
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Allow access to Ashling private repos
      run: |
        git config --global url."https://${{ secrets.GITHUB_TOKEN }}@github.com/".insteadOf "https://github.com/"

    - name: Clone trace-decoder-tests
      run: |
        echo "üîπ Cloning trace-decoder-tests..."
        git clone https://github.com/AshlingMicrosystems/trace-decoder-tests.git
        echo "‚úÖ Clone successful"

    - name: Build Sifive Decoder
      run: |
        echo "üîπ Building Sifive Decoder"
        cd "$GITHUB_WORKSPACE"
        echo "Changed to repository root:"
        pwd

        # Clean and build the main decoder project
        make CONFIG=Release clean
        make CONFIG=Release all

        # Clean and build libtrace.so inside the cloned trace-decoder-tests project
        echo "üîπ Building libtrace.so from trace-decoder-tests"
        cd "$GITHUB_WORKSPACE/trace-decoder-tests"
        make CONFIG=Release clean
        make CONFIG=Release all

    - name: Prepare artifacts
      run: |
        echo "Preparing Sifive Trace Decoder artifacts..."
        TRACE_LIB="$GITHUB_WORKSPACE/trace-decoder-tests/Release/libtrace.so"
        DECODER_LIB="$GITHUB_WORKSPACE/Release/libdqr.so"

        # Validate outputs
        if [ ! -f "$TRACE_LIB" ]; then
          echo "‚ùå libtrace.so not found!"
          exit 1
        fi
        if [ ! -f "$DECODER_LIB" ]; then
          echo "‚ùå libdqr.so not found!"
          exit 1
        fi

        mkdir -p "$GITHUB_WORKSPACE/artifacts/SifiveDecoder"
        cp "$TRACE_LIB" "$GITHUB_WORKSPACE/artifacts/SifiveDecoder/libtrace.so"
        cp "$DECODER_LIB" "$GITHUB_WORKSPACE/artifacts/SifiveDecoder/libdqr.so"
        echo "‚úÖ Artifacts ready:"
        ls -l "$GITHUB_WORKSPACE/artifacts/SifiveDecoder"

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: SifiveDecoder-libs
        path: ${{ github.workspace }}/artifacts/SifiveDecoder/
