name: DQR_Tests

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  build_and_test:
    runs-on: ubuntu-latest

    steps:
    # Step 1: Checkout source
    - uses: actions/checkout@v4

    # Step 2: Clean and build DQR
    - name: Build DQR
      run: |
        echo "ðŸ”¹ Cleaning and building DQR..."
        make clean
        make && make install
        echo "âœ… Build complete."

    # Step 3: Fetch trace-decoder tests
    - name: Get DQR Tests
      run: |
        echo "ðŸ”¹ Cloning trace-decoder-tests..."
        git clone https://github.com/sifive/trace-decoder-tests
        echo "âœ… Tests downloaded."

    # Step 4: Clean test environment
    - name: Clean test environment
      run: |
        cd trace-decoder-tests
        make clean

    # Step 5: Run tests
    - name: Run DQR Tests
      run: |
        cd trace-decoder-tests
        echo "ðŸ”¹ Running DQR tests..."
        make DQRPATH=$(pwd)/../install
        echo "âœ… Tests completed."

    # Step 6: Prepare artifacts
    - name: Prepare artifacts
      run: |
        echo "ðŸ”¹ Preparing artifacts..."
        mkdir -p "$GITHUB_WORKSPACE/artifacts/DQR"
        
        # Copy test results (if generated)
        if [ -f "trace-decoder-tests/result.log" ]; then
          cp "trace-decoder-tests/result.log" "$GITHUB_WORKSPACE/artifacts/DQR/"
        fi
        
        # Copy build/install directory contents (the DQR binaries/libraries)
        if [ -d "install" ]; then
          cp -r install/* "$GITHUB_WORKSPACE/artifacts/DQR/"
        fi

        echo "âœ… Artifacts prepared."

    # Step 7: Upload artifacts for GitLab or manual retrieval
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: DQR-artifacts
        path: ${{ github.workspace }}/artifacts/DQR/
